<html>

<head>
    <!-- Load the d3 library. -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Lato:400i|Permanent+Marker" rel="stylesheet">
    <script src="http://vizjs.org/viz.v1.1.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Lato:400" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style/style.css" media="all"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>California Wildfires</title>

</head>

<body>
  <div class="header">
    <!-- <div class="line" id="line1"></div> -->
    <div class="title">
      <img alt="fire" src="images/fire.png"/>
      <h1>CALIFORNIA WILDFIRES</h1>
      <!-- <span id="subtitle">AND <br/> LANDSLIDES</span> -->
    </div>
  </div>


  <div class="sections">

  <div class="section_parent">
  <div class="section"  id="map_about">
      <div class="map_description">
        <!-- <div class="map_description_bg"></div> -->
        <span id="map_title" class="section_title graph_title" >
        Wildfire Causes and Fire Size Trends</span>
        <!-- <div class="line" id="line3"></div> -->
        <p>
        Where fire catches, destruction occurs. This is evident in
        states like California where the combination of California's
        terrain and climate make it a common victim of such destructive
        forest fires. The unqiuely dry seasons and plentiful
        forests allow for wildfires to spread up to over 170,000 acres.

        <br/>
        <br/>
        In particular, the large number of wildfires is prevelant in
        the mountain regions. These mountain regions are occupied by
        masses of forests.

        </p>

      </div>


      <!-- <svg id="map_svg" width="1100" height="800"></svg> -->

    </div>

  <!-- <div class="section" id="map_stats">
  </div> -->
</div>

  <div class="section" id="map_ca">

  </div>


      <!-- <svg id="map_svg" width="900" height="1000"></svg>  -->
  <div class="section"  id="graph">
    <div class="graph_description">
      <span class="section_title graph_title" id="graph_title" >
      Human Intervention Prevalant in Wildfire Causes</span>
      <!-- <div class="line" id="line4"></div> -->
      <p>
        Over the years, fires have been categorized by causes such as by
        lightening, debris burning, and more. A majority of these wildfires
        are revealed to be caused by human intervention. From 1992 to 2009,
        natural wildfire causes seemingly decrease over the years. Namely,
        in the earlier years, lightening was a big trigger for wildfires.
        Now, in the later years, the combination of other human causes
        (arson, campfires, etc.) dominate the causes of wildfires.

      </p>
    </div>



    <!-- <svg id="graph_svg" width="500" height="400"></svg> -->


  </div>

  <div class="footer">
  </div>


    <script>

      var width = 848;
      //console.log("Here!!");
      var height = 725;

      var projection = d3.geo.mercator()
      .scale(3000)
      .center([-120, 36])
      .translate([width/2, height/2 + 100]);

      //an array containing coordinates [long, lat]
      var coordinates = [];
      //an array containing [cause, total, ...]
      var causes = [];
      //an array containing [[year, cause, total num in year, total num of cause in that year], ...]


      var bipartitieArr = [];

      var years = [];
      //var projection = d3.geo.albersUsa() //works but tried another method above
      //  .scale(2500)
      //  .translate([1000, 360]);

      var year_and_cause = [];

      var rScale = d3.scaleSqrt()
        .domain([0.0, 1])
        .range([1, 3]);


      var path = d3.geo.path()
        .projection(projection);

      var svg = d3.select("#map_ca").append("svg")

        .attr("width", width)
        .attr("height", height);
        // .attr("translate", "(-50, 0);");

      d3.queue()
        .defer(d3.json, ("datasets/CACounties.json"))
        .defer(d3.csv, ("datasets/NewFires.csv"))
        .await(callback);

        function callback(error, ca, fire) {
          showCA(ca);
          showFire(fire);
          showBiPartite(fire);



        }




    function showCA(ca) {

      //console.log(ca.objects.caCounties); //for navigating the data in the console
      svg.append("path")
        .datum(topojson.feature(ca, ca.objects.subunits))
        .attr("class", "land")
        .attr("d", path);
      //bind feature data to the map
      svg.selectAll(".subunit")
          .data(topojson.feature(ca, ca.objects.subunits).features)
        .enter().append("path")
        .attr("class", function(d) { return "subunit " + d.properties.name; })
        .attr("d", path)
        .style("fill", "#f7f7f7")
        .on("mouseover", function(d){
         //tooltip
          div.transition()
            .duration(200)
            .style("opacity", .9);
          div.html(d.properties.fullName)
            .style("left", (d3.event.pageX  ) + "px")
            .style("top", (d3.event.pageY - 9) + "px");
            // console.log(d3.event.pageX - 300, d3.event.pageY - 500);

        })
        .on("mouseout", function(d) {
          div.transition()
            .duration(300)
            .style("opacity", 0.0);
        });

      //exterior border
      svg.append("path")
        .datum(topojson.mesh(ca, ca.objects.subunits, function(a, b) { return a === b;}))
        .attr("d", path)
        .attr("stroke-opacity", 0.3)
        .attr("class", "exterior-boundary");

      //tooltop declaration
      var div = d3.select("#map_ca").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    }




    function showFire(fireData) {

      causes = [
        "Miscellaneous", 12099,
        "Lightning", 17451,
        "Debris Burning", 2284,
        "Campfire", 5616,
        "Equipment Use", 7271,
        "Children", 1643,
        "Arson", 8200,
        "Smoking", 1707,
        "Railroad", 210,
        "Fireworks", 153,
        "Structure", 71,
        "Powerline", 743,
        "Missing/Undefined", 295
      ];

      years = [
        1992, 4072,
        1993, 2406,
        1994, 3054,
        1995, 2332,
        1996, 3366,
        1997, 2719,
        1998, 3520,
        1999, 4734,
        2000, 3165,
        2001, 3709,
        2002, 3019,
        2003, 3484,
        2004, 3082,
        2005, 2558,
        2006, 3699,
        2007, 4548,
        2008, 2175,
        2009, 2101,
      ];

      years_nototal = [
        1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003,
        2004, 2005, 2006, 2007, 2008, 2009
      ];

      causes_nototal = [
        "Miscellaneous",
        "Lightning",
        "Debris Burning",
        "Campfire",
        "Equipment Use",
        "Children",
        "Arson",
        "Smoking",
        "Railroad",
        "Fireworks",
        "Structure",
        "Powerline",
        "Missing/Undefined"
      ];


      bipartitieArr = [

      ];





      fireData.forEach(function(d) {

  			// d.FIRE_YEAR = +d.FIRE_YEAR;
  			d.LATITUDE = +d.LATITUDE;
  			d.LONGITUDE = +d.LONGITUDE;
  			d.FIRE_SIZE = +d.FIRE_SIZE;

        var array = [d.LONGITUDE, d.LATITUDE, d.FIRE_SIZE];
        coordinates.push(array);

        var str = d.STAT_CAUSE_DESCR + " " +  d.FIRE_YEAR;
        // console.log(str);

        if (year_and_cause.indexOf(str) == -1) {
          year_and_cause.push(str);
          year_and_cause.push(1);
        } else {
          var i = year_and_cause.indexOf(str);
          // console.log(i);
          var num = year_and_cause[i + 1];
          year_and_cause[i + 1] = num + 1;
        }


  		});

      for (i = 0; i < year_and_cause.length; i = i + 2) {
        var arr = [];

        var year_i = year_and_cause[i].length - 4;
        var cause_i = year_and_cause[i].length - 5;
        var year = year_and_cause[i].substring(year_i, year_and_cause.length - 1);
        var cause = year_and_cause[i].substring(0, cause_i);

        arr = [year, cause, year_and_cause[i+1]];


        bipartitieArr.push(arr);

      }


      // console.log(bipartitieArr);




      var circles = svg.selectAll("circle")
        .data(coordinates);


      circles.enter()
        .append("circle")
        .attr("r", function(d) {
          if ((d[2] > 1) && (d[2] <= 1000 )) { return 4; }
          else if ((d[2] > 1000) && (d[2] <= 10000 )) { return 9; }
          else if((d[2] > 10000)) {return 12;}

          // return rScale(d[3]);
          else {return rScale(d[2]);}
        })
        .merge(circles)
        .attr("cx", function(d) { return projection(d)[0]; })
        .attr("cy", function(d) { return projection(d)[1]; })
        .attr("fill", function(d) {
          if ((d[2] > 1) && (d[2] <= 1000 )) { return "#e9874f"; }
          else if ((d[2] > 1000) && (d[2] <= 10000 )) { return "#e9d44f"; }
          else if ((d[2] > 10000)) { return "#f2b593"; }
          // return rScale(d[3]);
          else {return "#E94F64";}
        });



    }

    function showBiPartite(fire) {

      var width = 1150;
      var height = 700;

      //format of data [year, cause, total num in year, total num of cause in that year]
      var data = bipartitieArr;
      var color = {

        "1992": "#E5DD00",
        "1993": "#E2D001",
        "1994": "#E0C302",
        "1995": "#DEB604",
        "1996": "#DCA905",
        "1997": "#D99C06",
        "1998": "#D78F08",
        "1999": "#D58209",
        "2000": "#D3750A",
        "2001": "#D0680C",
        "2002": "#CE5B0D",
        "2003": "#CC4E0E",
        "2004": "#CA4110",
        "2005": "#C73411",
        "2006": "#C52712",
        "2007": "#C31A14",
        "2008": "#C10D15",
        "2009": "#BF0017",


      };


      var svg2 = d3.select("#graph")
        .append("svg").attr("width", width).attr("height", height)
        .attr("class", "graph_svg");
        // .append("g").attr("transform","translate(100,100)");
        // .call(bp);
      var g = svg2.append("g").attr("transform","translate(175, 50)");

      var bp=viz.bP()
      .data(data)
      .min(30)
  		.pad(1)
      .height(550)
      .width(900)
      .orient("horizontal")
  		.barSize(50)
      .fill(d=>color[d.primary]);

      g.call(bp);

      g.selectAll(".mainBars")
      	.on("mouseover",mouseover)
      	.on("mouseout",mouseout)

      g.selectAll(".mainBars").append("text").attr("class","label")
      	.attr("y",d=>(d.part=="primary"? -42: 35))
      	.attr("x",d=>(d.part=="primary"? 15: 20))
      	.text(d=>d.key)
        .attr("fill", "#E4A408")
        .attr("transform", d=>(d.part=="primary"? "rotate(0)":"rotate(45)"))
        .style("font-size",  "12px")
      	.attr("text-anchor",d=>(d.part=="primary"? "end": "start"));

      g.selectAll(".mainBars").append("text").attr("class","perc")
      	.attr("y",d=>(d.part=="primary"? -27: 45))
      	.attr("x",d=>(d.part=="primary"? +12: 20))
        .attr("transform", d=>(d.part=="primary"? "rotate(0)":"rotate(45)"))
      	.text(function(d){ return (d3.format(".2f")(d.percent * 100)) + "%"})
        .style("font-size", "10px")
        .attr("fill", "#E4A408")
      	.attr("text-anchor",d=>(d.part=="primary"? "end": "start"));

      function mouseover(d){
      	bp.mouseover(d);
        svg2.style("cursor", "pointer");
      	g.selectAll(".mainBars")
      	.select(".perc")
      	.text(function(d){ return (d3.format(".2f")(d.percent * 100)) + "%"})
      }
      function mouseout(d){
      	bp.mouseout(d);
      	g.selectAll(".mainBars")
      		.select(".perc")
      	.text(function(d){ return (d3.format(".2f")(d.percent * 100)) + "%"})
      }


      svg2.append("text")
      .attr("x",105)
      .attr("y", 85)
      .style("text-anchor","middle")
      .style("font-size", "32px")
      .style("font-family", "'Lato', sans-serif")
      .style("text-transform", "uppercase")
      .style("font-weight", 1000)
      .attr("fill", "#E4A408")
      .text("Years");


      svg2.append("text")
      .attr("x", 105)
      .attr("y", height - 115)
      .style("text-anchor","middle")
      .style("font-size", "32px")
      .style("font-family", "'Lato', sans-serif")
      .style("text-transform", "uppercase")
      .style("font-weight", 1000)
      .attr("fill", "#E4A408")
      .text("Causes ");






      // adjust height of frameElement in bl.ocks.org
      d3.select(self.frameElement).style("height", "660px");

      //adds title

      // svg2.append("text")
      // .attr("x",width/2 - 100)
      // .attr("y", 0)
      // .attr("class","g_header")
      // .text("BiPartite Graph of Cause vs. Year")
      // .attr("transform","translate(-220,-60)")
      // .style("font-size", "32px")
      // .style("font-family", "'Lato', sans-serif")
      // .style("text-transform", "uppercase")
      // .style("font-weight", 600);
    }






    </script>

</body>

</html>
